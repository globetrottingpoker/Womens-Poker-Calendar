<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Women's Poker Calendar</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<style>
  body {
    font-family: 'Inter', Arial, sans-serif;
    background: #f9fafc;
    color: #000;
    margin: 0;
    padding: 20px;
  }
  h2 {
    text-align: center;
    margin-bottom: 6px;
    color: #000;
    font-size: 22px;
  }
  .filters { max-width:1200px; margin:0 auto 20px; display:flex; flex-wrap:wrap; gap:8px; }
  .filters select { padding:6px; font-size: 14px; border:1px solid #ccc; border-radius: 4px; }
  .dt-container {
    overflow-x: auto;
    margin: 0 auto 40px;
  }
  .toggle-past-btn {
    display: block;
    margin: 0 auto 20px;
    padding: 10px 24px;
    background: #2e7be6;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
  }
  .toggle-past-btn:focus { outline: none; }
  #pastEventsSection.collapsed {
    display: none;
  }
  table.display {
    width: 100%;
    min-width: 1250px;
    border-collapse: collapse;
  }
  th, td {
    font-size: 14px;
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
    vertical-align: middle;
  }
  .date-cell {
    font-weight: 400;
    font-size: 0.9em;
    text-align: center;
    min-width: 44px;
    padding: 6px 8px;
  }
  .date-stack {
    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 1.1;
  }
  .date-month {
    font-size: 0.9em;
    text-transform: uppercase;
    color: #222;
    letter-spacing: 0.5px;
    font-weight: 400;
  }
  .date-day {
    font-size: 1.2em;
    color: #222;
    font-weight: 400;
    line-height: 1.1;
  }
  .flag-cell img {
    max-width: 32px;
    margin-right: 8px;
    vertical-align: middle;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }
  .series-cell { white-space: normal; min-width: 135px; }
  .series-name a,
  .series-name span {
    font-weight: 600;
    text-decoration: none;
  }
  .series-name a:hover {
    text-decoration: underline;
  }
  .series-location {
    font-size: 1em;
    color: #000;
    font-weight: 400;
    margin-top: 2px;
  }
  .series-dates {
    font-size: 0.98em;
    color: #333;
    margin-top: 2px;
    font-weight: 400;
  }
  .type-cell {
    text-align: center;
    font-size: 1.2em;
    min-width: 34px;
  }
  .venue-cell a {
    color: #0066cc;
    text-decoration: none;
  }
  .venue-cell a:hover {
    text-decoration: underline;
  }
  .host-cell a {
    color: #228b22;
    text-decoration: none;
    font-weight: 500;
  }
  .host-cell a:hover {
    text-decoration: underline;
  }
  @media (max-width: 600px) {
    table.display, .dt-container {
      font-size: 0.9em;
    }
    th, td {
      padding: 6px 4px;
    }
    .state-cell, .moreinfo-cell {
      display: none;
    }
    .date-cell {
      min-width: 36px;
    }
  }
</style>
</head>
<body>

<h2>Upcoming Events</h2>

<div class="filters">
  <select id="seriesFilter"><option value="">All Series</option></select>
  <select id="hostFilter"><option value="">All Hosts</option></select>
  <select id="cityFilter"><option value="">All Cities</option></select>
  <select id="regionFilter"><option value="">All Regions</option></select>
  <select id="venueFilter"><option value="">All Venues</option></select>
</div>
<div id="calendarError" style="display:none; color:#b00; background:#fff0f0; padding:18px; border-radius:8px; margin:30px auto; max-width:600px; text-align:center; font-size:1.2em;">
  Sorry, we couldn't load the calendar. Please check your API connection and try again.
</div>
<div class="dt-container">
  <table id="calendarTable" class="display" cellspacing="0" cellpadding="0">
    <thead>
      <tr>
        <th>Date</th>
        <th></th>
        <th>Series</th>
        <th>Event</th>
        <th>BuyIn / GTD</th>
        <th>Type</th>
        <th>Host</th>
        <th>City</th>
        <th>Region(US State or Country)</th>
        <th>Venue</th>
        <th>More Info</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<button class="toggle-past-btn" id="togglePastEvents">Show Past Events</button>
<div id="pastEventsSection" class="collapsed" style="display:none;">
  <h2>Past Events</h2>
  <div id="pastCalendarError" style="display:none; color:#b00; background:#fff0f0; padding:18px; border-radius:8px; margin:30px auto; max-width:600px; text-align:center; font-size:1.2em;">
    Sorry, we couldn't load the calendar. Please check your API connection and try again.
  </div>
  <div class="dt-container">
    <table id="pastCalendarTable" class="display" cellspacing="0" cellpadding="0">
      <thead>
        <tr>
          <th>Date</th>
          <th></th>
          <th>Series</th>
          <th>Event</th>
          <th>BuyIn / GTD</th>
          <th>Type</th>
          <th>Host</th>
          <th>City</th>
          <th>Region(US State or Country)</th>
          <th>Venue</th>
          <th>More Info</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let tableUpcoming, tablePast;

function escapeHtml(s) {
  if (s == null) return '';
  return String(s).replace(/[&<>"']/g, function (m) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": ''
    }[m];
  });
}

function getFlagCode(region, state, city) {
  let code = (region || state || city || '').toLowerCase().trim();
  if (code === 'oklahoma' || code === 'choctaw' || code === 'chochaw') return 'us';
  if (code === 'calgary') return 'ca';
  if (code === "st. julian's") return 'mt';
  if (code === 'tallinn') return 'ee';
  if (code === 'incheon' || code === 'jeju') return 'kr';
  if (code === 'taipei') return 'tw';
  if (code === 'cape town') return 'za';
  if (code.length === 2) return code;
  return 'xx';
}

function parseDate(dateStr) {
  if (!dateStr) return null;
  if (dateStr.trim().toUpperCase() === 'TBA' || dateStr.trim().toLowerCase() === 'ongoing') return null;
  let date;
  if (dateStr.includes('/')) {
    const [m, d, y] = dateStr.split('/');
    date = new Date(y, m - 1, d);
  } else if (dateStr.includes('-')) {
    date = new Date(dateStr);
  } else {
    return null;
  }
  if (isNaN(date.getTime())) return null;
  return date;
}

function parseSeriesDate(seriesDates) {
  if (!seriesDates) return null;
  let match = seriesDates.match(/([A-Za-z]+)\s+(\d{1,2}),?\s*(\d{4})?/);
  if (match) {
    let month = match[1];
    let day = match[2];
    let year = match[3];
    if (!year) {
      let yearMatch = seriesDates.match(/(\d{4})/g);
      year = yearMatch ? yearMatch[yearMatch.length - 1] : new Date().getFullYear();
    }
    let dateStr = `${month} ${day}, ${year}`;
    const d = new Date(dateStr);
    if (!isNaN(d)) return d;
  }
  return null;
}

function isTBA(dateStr) {
  return typeof dateStr === 'string' &&
    dateStr.trim().toUpperCase() === 'TBA';
}

function getSortableDate(event) {
  const eventDateStr = (event.eventDate || '').trim();
  if (eventDateStr.toLowerCase() === 'ongoing') {
    return -9999999999999;
  }
  if (isTBA(eventDateStr)) {
    const seriesDateObj = parseSeriesDate(event.seriesDates);
    if (seriesDateObj && !isNaN(seriesDateObj.getTime())) {
      return seriesDateObj.getTime();
    }
    return 9999999999998;
  }
  if (eventDateStr) {
    const dateObj = parseDate(eventDateStr);
    if (dateObj && !isNaN(dateObj.getTime())) {
      return dateObj.getTime();
    }
  }
  return 9999999999999;
}

function sortEvents(events, isUpcoming) {
  return events.slice().sort((a, b) => {
    const dateA = getSortableDate(a);
    const dateB = getSortableDate(b);
    return isUpcoming ? dateA - dateB : dateB - dateA;
  });
}

function formatDateCell(dateStr) {
  if (typeof dateStr === 'string' && dateStr.trim().toLowerCase() === 'ongoing') {
    return `<span style="color:#000; font-weight:bold;">ONGOING</span>`;
  }
  const date = parseDate(dateStr);
  if (!date || isNaN(date)) return escapeHtml(dateStr || '');
  const month = date.toLocaleString('default', { month: 'short' }).toUpperCase();
  const day = date.getDate();
  return `<div class="date-stack"><span class="date-month">${month}</span><span class="date-day">${day}</span></div>`;
}

function normaliseRegion(regionValue) {
  if (!regionValue) return '';
  const map = {
    us: 'United States', nv: 'Nevada', ok: 'Oklahoma', ny: 'New York',
    fl: 'Florida', tx: 'Texas', gb: 'United Kingdom', ca: 'Canada',
    mt: 'Malta', cy: 'Cyprus'
  };
  const key = regionValue.toLowerCase().trim();
  return map[key] || regionValue.trim();
}

function renderEvent(event, tbody) {
  const typeMap = {
    t: ' ',
    tournament: ' ',
    cash: ' ',
    mu: ' ',
    www: 'ðŸ’»'
  };
  const typeValue = (event.type || '').toString().trim().toLowerCase();
  const typeEmoji = typeMap[typeValue] || escapeHtml(event.type || '');

  let flagHtml = '';
  if (typeValue !== 'www') {
    if ((event.region || '').toLowerCase() !== 'x') {
      const flagCode = getFlagCode(event.region, event.state, event.city);
      flagHtml = `<img src="https://flagcdn.com/w80/${flagCode}.png" alt="${flagCode} flag"/>`;
    }
  }

  const dateCell = formatDateCell(event.eventDate);
  const venueLink = event.venueLink || '';
  const venueName = event.venue || '';
  const venueHtml = venueLink && venueName ? `<a href="${venueLink}" target="_blank">${escapeHtml(venueName)}</a>` : escapeHtml(venueName);
  const buyinGtd = escapeHtml(event.buyIn || event['BuyIn / GTD'] || '');
  const host = escapeHtml(event.host || '');
  const hostLink = event.hostLink || '';
  const hostHtml = hostLink && host ? `<a href="${hostLink}" target="_blank">${host}</a>` : host;
  const seriesColor = event.seriesColor || '#000';
  const seriesName = escapeHtml(event.series || '');
  const seriesDetails = event.seriesDetails || '';
  const seriesNameHtml = seriesDetails
    ? `<a href="${seriesDetails}" target="_blank" style="color:${seriesColor}; font-weight:600; text-decoration:none;">${seriesName}</a>`
    : `<span style="color:${seriesColor}; font-weight:600;">${seriesName}</span>`;
  const seriesLocation = escapeHtml(event.seriesLocation || '');
  const seriesDates = escapeHtml(event.seriesDates || '');
  const seriesHtml = `
    <div class="series-name">${seriesNameHtml}</div>
    <div class="series-location">${seriesLocation}</div>
    <div class="series-dates">${seriesDates}</div>
  `;
  const city = escapeHtml(event.city || '');
  const regionDisplay = event.regionDisplay ? escapeHtml(event.regionDisplay) : escapeHtml(event.state || event.region || '');
  const moreInfoText = escapeHtml(event.moreInfo || event.moreInformation || '');

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="date-cell">${dateCell}</td>
    <td class="flag-cell">${flagHtml}</td>
    <td class="series-cell">${seriesHtml}</td>
    <td class="event-cell">${escapeHtml(event.event || '')}</td>
    <td class="buyin-cell">${buyinGtd}</td>
    <td class="type-cell">${typeEmoji}</td>
    <td class="host-cell">${hostHtml}</td>
    <td class="city-cell">${city}</td>
    <td class="state-cell">${regionDisplay}</td>
    <td class="venue-cell">${venueHtml}</td>
    <td class="moreinfo-cell">${moreInfoText}</td>
  `;
  tbody.appendChild(tr);
}

function loadCalendarData() {
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSFb5W0eV-irQWn1MDU5h3LArwSv2sPto8yh-SjKWhXDZk5h8zHJ43NMeXL7Vfyt-C0IhawjoUqJQLE/pub?output=csv';

  fetch(csvUrl)
    .then(response => response.text())
    .then(csvText => {
      const data = parseCSV(csvText);

      const upcoming = [];
      const past = [];
      const upcomingTbody = document.querySelector('#calendarTable tbody');
      const pastTbody = document.querySelector('#pastCalendarTable tbody');
      upcomingTbody.innerHTML = '';
      pastTbody.innerHTML = '';

data.forEach(event => {
  // Helper: always extract value and convert to a string, then .trim()
  function getKey(obj, keys) {
    for (const key of keys) {
      if (obj.hasOwnProperty(key)) return String(obj[key]).trim();
    }
    return '';
  }

  // Only skip if Series is missing (everything else goes through)
  if (!getKey(event, ['Series', 'series'])) return;

  // Map and robustly trim all potential fields
  event.series = getKey(event, ['Series', 'series']);
  event.eventDate = getKey(event, ['Event Date', 'event date', 'EventDate', 'eventDate']);
  event.seriesDates = getKey(event, ['Series Dates', 'series dates', 'SeriesDates', 'seriesDates']);
  event.host = getKey(event, ['Host', 'host']);
  event.city = getKey(event, ['City', 'city']);
  event.region = getKey(event, ['Region', 'region']);
  event.state = getKey(event, ['State', 'state']);
  event.venue = getKey(event, ['Venue', 'venue']);
  event.venueLink = getKey(event, ['Venue Link', 'venue link']);
  event.hostLink = getKey(event, ['Host Link', 'host link']);
  event.seriesDetails = getKey(event, ['Series Details', 'series details']);
  event.buyIn = getKey(event, ['BuyIn / GTD', 'buyin / gtd', 'BuyIn_GTD']);
  event.type = getKey(event, ['Type', 'type']);
  event.moreInfo = getKey(event, ['More Info', 'more info']);
  event.event = getKey(event, ['Event', 'event']);
  event.regionDisplay = normaliseRegion(event.state || event.region).trim();

  // Push EVERY event with a series to upcoming or past
  if (event.series) {
    if (isUpcomingEvent(event)) {
      upcoming.push(event);
    } else if (isPastEvent(event)) {
      past.push(event);
    }
  }
});



      sortEvents(upcoming, true).forEach(event => renderEvent(event, upcomingTbody));
      sortEvents(past, false).forEach(event => renderEvent(event, pastTbody));

      if ($.fn.DataTable.isDataTable('#calendarTable')) {
        tableUpcoming.destroy();
      }
      if ($.fn.DataTable.isDataTable('#pastCalendarTable')) {
        tablePast.destroy();
      }

      tableUpcoming = $('#calendarTable').DataTable({
        responsive: true,
        scrollX: true,
        paging: true,
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        info: false,
        order: [],
        destroy: true,
      });

      tablePast = $('#pastCalendarTable').DataTable({
        responsive: true,
        scrollX: true,
        paging: true,
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        info: false,
        order: [],
        destroy: true,
      });

      function populateFilterOptions(id, values, label) {
        const sel = document.getElementById(id);
        if (!sel) return;
        const first = sel.querySelector('option[value=""]');
        sel.innerHTML = '';
        if (first) {
          sel.appendChild(first);
        } else {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = label;
          sel.appendChild(opt);
        }
        [...new Set(values.filter(Boolean))].sort().forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.trim();
          opt.textContent = v.trim();
          sel.appendChild(opt);
        });
      }

      populateFilterOptions('seriesFilter', data.map(e => e.Series || e.series), 'All Series');
      populateFilterOptions('hostFilter', data.map(e => e.Host || e.host), 'All Hosts');
      populateFilterOptions('cityFilter', data.map(e => e.City || e.city), 'All Cities');
      populateFilterOptions('regionFilter', data.map(e => normaliseRegion(e.State || e.state || e.Region || e.region)), 'All Regions');
      populateFilterOptions('venueFilter', data.map(e => e.Venue || e.venue), 'All Venues');

      $('#seriesFilter').off('change').on('change', function () {
        tableUpcoming.column(2).search(this.value).draw();
        tablePast.column(2).search(this.value).draw();
      });
      $('#hostFilter').off('change').on('change', function () {
        tableUpcoming.column(6).search(this.value).draw();
        tablePast.column(6).search(this.value).draw();
      });
      $('#cityFilter').off('change').on('change', function () {
        tableUpcoming.column(7).search(this.value).draw();
        tablePast.column(7).search(this.value).draw();
      });
      $('#regionFilter').off('change').on('change', function () {
        tableUpcoming.column(8).search(this.value).draw();
        tablePast.column(8).search(this.value).draw();
      });
      $('#venueFilter').off('change').on('change', function () {
        tableUpcoming.column(9).search(this.value).draw();
        tablePast.column(9).search(this.value).draw();
      });
    })
    .catch(() => {
      document.getElementById('calendarError').style.display = 'block';
      document.getElementById('pastCalendarError').style.display = 'block';
    });
}

