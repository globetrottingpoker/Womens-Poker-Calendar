<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Women's Poker Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #f9fafc; color: #000; margin: 0; padding: 20px; }
    h2 { text-align: center; margin-bottom: 24px; color: #000; font-size: 22px; }
    .dt-container { overflow-x: auto; margin: 0 auto 40px; }
    .toggle-past-btn { display: block; margin: 0 auto 20px; padding: 10px 24px; background: #2e7be6; color: #fff; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; }
    .toggle-past-btn:focus { outline: none; }
    #pastEventsSection.collapsed { display: none; }
    table.display { width: 100%; min-width: 1250px; border-collapse: collapse; }
    th, td { font-size: 14px; padding: 10px; text-align: left; border-bottom: 1px solid #e0e0e0; vertical-align: middle; }
    .date-cell { font-weight: 400; font-size: 0.9em; text-align: center; min-width: 44px; padding: 6px 8px; }
    .date-stack { display: flex; flex-direction: column; align-items: center; line-height: 1.1; }
    .date-month { font-size: 0.9em; text-transform: uppercase; color: #222; letter-spacing: 0.5px; font-weight: 400; }
    .date-day { font-size: 1.2em; color: #222; font-weight: 400; line-height: 1.1; }
    .flag-cell img { max-width: 32px; margin-right: 8px; vertical-align: middle; display: block; margin-left: auto; margin-right: auto; }
    .series-cell { white-space: normal; min-width: 135px; }
    .series-name a, .series-name span { font-weight: 600; text-decoration: none; }
    .series-name a:hover { text-decoration: underline; }
    .series-location { font-size: 1em; color: #000; font-weight: 400; margin-top: 2px; }
    .series-dates { font-size: 0.98em; color: #333; margin-top: 2px; font-weight: 400; }
    .type-cell { text-align: center; font-size: 1.2em; min-width: 34px; }
    .venue-cell a { color: #0066cc; text-decoration: none; }
    .venue-cell a:hover { text-decoration: underline; }
    .host-cell a { color: #228b22; text-decoration: none; font-weight: 500; }
    .host-cell a:hover { text-decoration: underline; }
    @media (max-width: 600px) {
      table.display, .dt-container { font-size: 0.9em; }
      th, td { padding: 6px 4px; }
      .state-cell, .moreinfo-cell { display: none; }
      .date-cell { min-width: 36px; }
    }
  </style>
</head>
<body>
  <h2>Upcoming Events</h2>
  <div id="calendarError" style="display:none; color:#b00; background:#fff0f0; padding:18px; border-radius:8px; margin:30px auto; max-width:600px; text-align:center; font-size:1.2em;">
    Sorry, we couldn't load the calendar. Please check your API connection and try again.
  </div>
  <div class="dt-container">
    <table id="calendarTable" class="display" cellspacing="0" cellpadding="0">
      <thead>
        <tr>
          <th>Date</th>
          <th></th>
          <th>Series</th>
          <th>Event</th>
          <th>BuyIn / GTD</th>
          <th>Type</th>
          <th>Host</th>
          <th>City</th>
          <th>Region(US State or Country)</th>
          <th>Venue</th>
          <th>More Info</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="toggle-past-btn" id="togglePastEvents">Show Past Events</button>
  <div id="pastEventsSection" class="collapsed">
    <h2>Past Events</h2>
    <div id="pastCalendarError" style="display:none; color:#b00; background:#fff0f0; padding:18px; border-radius:8px; margin:30px auto; max-width:600px; text-align:center; font-size:1.2em;">
      Sorry, we couldn't load the calendar. Please check your API connection and try again.
    </div>
    <div class="dt-container">
      <table id="pastCalendarTable" class="display" cellspacing="0" cellpadding="0">
        <thead>
          <tr>
            <th>Date</th>
            <th></th>
            <th>Series</th>
            <th>Event</th>
            <th>BuyIn / GTD</th>
            <th>Type</th>
            <th>Host</th>
            <th>City</th>
            <th>Region(US State or Country)</th>
            <th>Venue</th>
            <th>More Info</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // https://gist.github.com/Keeguon/2310008 (ISO 3166-1 alpha-2 to country)
    const regionNameMap = {
      us:"United States", gb:"United Kingdom", cy:"Cyprus", mt:"Malta", ca:"Canada", za:"South Africa", kr:"South Korea", tw:"Taiwan", ee:"Estonia", de:"Germany", es:"Spain", fr:"France", it:"Italy", nl:"Netherlands", be:"Belgium", se:"Sweden", dk:"Denmark", fi:"Finland", no:"Norway", au:"Australia", at:"Austria", az:"Azerbaijan", ar:"Argentina", pl:"Poland", ru:"Russia", ch:"Switzerland", ie:"Ireland", cz:"Czech Republic", sg:"Singapore", tr:"Turkey", pt:"Portugal", hk:"Hong Kong", jp:"Japan", br:"Brazil", mx:"Mexico", th:"Thailand", mc:"Monaco", hu:"Hungary", bg:"Bulgaria", lt:"Lithuania", ro:"Romania", cl:"Chile", lv:"Latvia", sk:"Slovakia", il:"Israel", gr:"Greece", si:"Slovenia", ua:"Ukraine", hr:"Croatia", my:"Malaysia", ae:"United Arab Emirates",
      af:"Afghanistan", al:"Albania", dz:"Algeria", as:"American Samoa", ad:"Andorra", ao:"Angola", ai:"Anguilla", aq:"Antarctica", ag:"Antigua and Barbuda", am:"Armenia", aw:"Aruba", at:"Austria", az:"Azerbaijan", bs:"Bahamas", bh:"Bahrain", bd:"Bangladesh", bb:"Barbados", by:"Belarus", be:"Belgium", bz:"Belize", bj:"Benin", bm:"Bermuda", bt:"Bhutan", bo:"Bolivia", ba:"Bosnia and Herzegovina", bw:"Botswana", br:"Brazil", io:"British Indian Ocean Territory", bn:"Brunei Darussalam", bg:"Bulgaria", bf:"Burkina Faso", bi:"Burundi", kh:"Cambodia", cm:"Cameroon", cv:"Cape Verde", ky:"Cayman Islands", cf:"Central African Republic", td:"Chad", cl:"Chile", cn:"China", cx:"Christmas Island", cc:"Cocos (Keeling) Islands", co:"Colombia", km:"Comoros", cg:"Congo", cd:"Congo, the Democratic Republic of the", ck:"Cook Islands", cr:"Costa Rica", ci:"CÃ´te d'Ivoire", hr:"Croatia", cu:"Cuba", cz:"Czech Republic", dk:"Denmark", dj:"Djibouti", dm:"Dominica", do:"Dominican Republic", ec:"Ecuador", eg:"Egypt", sv:"El Salvador", gq:"Equatorial Guinea", er:"Eritrea", ee:"Estonia", et:"Ethiopia", fk:"Falkland Islands (Malvinas)", fo:"Faroe Islands", fj:"Fiji", fi:"Finland", fr:"France", gf:"French Guiana", pf:"French Polynesia", tf:"French Southern Territories", ga:"Gabon", gm:"Gambia", ge:"Georgia", de:"Germany", gh:"Ghana", gi:"Gibraltar", gr:"Greece", gl:"Greenland", gd:"Grenada", gp:"Guadeloupe", gu:"Guam", gt:"Guatemala", gg:"Guernsey", gn:"Guinea", gw:"Guinea-Bissau", gy:"Guyana", ht:"Haiti", hm:"Heard Island and Mcdonald Islands", va:"Holy See (Vatican City State)", hn:"Honduras", hk:"Hong Kong", hu:"Hungary", is:"Iceland", in:"India", id:"Indonesia", ir:"Iran", iq:"Iraq", ie:"Ireland", im:"Isle of Man", il:"Israel", it:"Italy", jm:"Jamaica", jp:"Japan", je:"Jersey", jo:"Jordan", kz:"Kazakhstan", ke:"Kenya", ki:"Kiribati", kp:"North Korea", kr:"South Korea", kw:"Kuwait", kg:"Kyrgyzstan", la:"Laos", lv:"Latvia", lb:"Lebanon", ls:"Lesotho", lr:"Liberia", ly:"Libya", li:"Liechtenstein", lt:"Lithuania", lu:"Luxembourg", mo:"Macao", mk:"North Macedonia", mg:"Madagascar", mw:"Malawi", my:"Malaysia", mv:"Maldives", ml:"Mali", mh:"Marshall Islands", mq:"Martinique", mr:"Mauritania", mu:"Mauritius", yt:"Mayotte", mx:"Mexico", fm:"Micronesia", md:"Moldova", mc:"Monaco", mn:"Mongolia", me:"Montenegro", ms:"Montserrat", ma:"Morocco", mz:"Mozambique", mm:"Myanmar", na:"Namibia", nr:"Nauru", np:"Nepal", nl:"Netherlands", nc:"New Caledonia", nz:"New Zealand", ni:"Nicaragua", ne:"Niger", ng:"Nigeria", nu:"Niue", nf:"Norfolk Island", mp:"Northern Mariana Islands", no:"Norway", om:"Oman", pk:"Pakistan", pw:"Palau", ps:"Palestine", pa:"Panama", pg:"Papua New Guinea", py:"Paraguay", pe:"Peru", ph:"Philippines", pn:"Pitcairn", pl:"Poland", pt:"Portugal", pr:"Puerto Rico", qa:"Qatar", re:"Reunion", ro:"Romania", ru:"Russia", rw:"Rwanda", bl:"Saint Barthelemy", sh:"Saint Helena", kn:"Saint Kitts and Nevis", lc:"Saint Lucia", mf:"Saint Martin", pm:"Saint Pierre and Miquelon", vc:"Saint Vincent and the Grenadines", ws:"Samoa", sm:"San Marino", st:"Sao Tome and Principe", sa:"Saudi Arabia", sn:"Senegal", rs:"Serbia", sc:"Seychelles", sl:"Sierra Leone", sg:"Singapore", sx:"Sint Maarten", sk:"Slovakia", si:"Slovenia", sb:"Solomon Islands", so:"Somalia", za:"South Africa", gs:"South Georgia and the South Sandwich Islands", es:"Spain", lk:"Sri Lanka", sd:"Sudan", sr:"Suriname", sj:"Svalbard and Jan Mayen", sz:"Eswatini", se:"Sweden", ch:"Switzerland", sy:"Syria", tw:"Taiwan", tj:"Tajikistan", tz:"Tanzania", th:"Thailand", tl:"Timor-Leste", tg:"Togo", tk:"Tokelau", to:"Tonga", tt:"Trinidad and Tobago", tn:"Tunisia", tr:"Turkey", tm:"Turkmenistan", tc:"Turks and Caicos Islands", tv:"Tuvalu", ug:"Uganda", ua:"Ukraine", ae:"United Arab Emirates", gb:"United Kingdom", us:"United States", um:"United States Minor Outlying Islands", uy:"Uruguay", uz:"Uzbekistan", vu:"Vanuatu", ve:"Venezuela", vn:"Vietnam", vg:"Virgin Islands, British", vi:"U.S. Virgin Islands", wf:"Wallis and Futuna", eh:"Western Sahara", ye:"Yemen", zm:"Zambia", zw:"Zimbabwe",
      // US states -- add as needed!
      nv:"Nevada", ca:"California", ok:"Oklahoma", ny:"New York", fl:"Florida", tx:"Texas", az:"Arizona", md:"Maryland", mt:"Montana", la:"Louisiana", ms:"Mississippi", nm:"New Mexico", or:"Oregon", wa:"Washington", mo:"Missouri", tn:"Tennessee", co:"Colorado", pa:"Pennsylvania", il:"Illinois"
    };

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSFb5W0eV-irQWn1MDU5h3LArwSv2sPto8yh-SjKWhXDZk5h8zHJ43NMeXL7Vfyt-C0IhawjoUqJQLE/pub?output=csv';

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/[&<>"']/g, function (m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        }[m];
      });
    }

    function getFlagCode(region, state, city) {
      let code = (region || state || city || '').toLowerCase().trim();
      if (code === 'oklahoma' || code === 'choctaw' || code === 'chochaw') return 'us';
      if (code === 'calgary') return 'ca';
      if (code === "st. julian's") return 'mt';
      if (code === 'tallinn') return 'ee';
      if (code === 'incheon' || code === 'jeju') return 'kr';
      if (code === 'taipei') return 'tw';
      if (code === 'cape town') return 'za';
      if (code.length === 2) return code;
      return 'xx';
    }

    function parseDate(dateStr) {
      if (!dateStr) return null;
      if (dateStr === 'TBA' || dateStr.toLowerCase() === 'ongoing') return null;
      let date;
      if (dateStr.includes('/')) {
        const [m, d, y] = dateStr.split('/');
        date = new Date(y, m - 1, d);
      } else if (dateStr.includes('-')) {
        date = new Date(dateStr);
      } else {
        return null;
      }
      if (isNaN(date.getTime())) return null;
      return date;
    }

    function parseSeriesDate(seriesDates) {
      if (!seriesDates) return null;
      let match = seriesDates.match(/([A-Za-z]+)\s+(\d{1,2}),?\s*(\d{4})?/);
      if (match) {
        let month = match[1];
        let day = match[2];
        let year = match[3];
        if (!year) {
          let yearMatch = seriesDates.match(/(\d{4})/g);
          year = yearMatch ? yearMatch[yearMatch.length - 1] : new Date().getFullYear();
        }
        let dateStr = `${month} ${day}, ${year}`;
        const d = new Date(dateStr);
        if (!isNaN(d)) return d;
      }
      return null;
    }

    function getSortableDate(event) {
      if (event["Event Date"] && typeof event["Event Date"] === 'string' && event["Event Date"].toLowerCase() === 'ongoing') {
        return -9999999999999; // Top priority
      }
      if (event["Event Date"] && event["Event Date"] !== 'TBA') {
        const d = parseDate(event["Event Date"]);
        if (d && !isNaN(d)) return d.getTime();
      }
      const seriesDate = parseSeriesDate(event["Series Dates"]);
      if (seriesDate) return seriesDate.getTime();
      return 9999999999999;
    }

    function sortEvents(events, isUpcoming) {
      return events.slice().sort((a, b) => {
        const dateA = getSortableDate(a);
        const dateB = getSortableDate(b);
        return isUpcoming ? dateA - dateB : dateB - dateA;
      });
    }

    function formatDateCell(dateStr) {
      if (typeof dateStr === 'string' && dateStr.toLowerCase() === 'ongoing') {
        return `<span style="color:#000; font-weight:bold;">ONGOING</span>`; // Black, bold
      }
      const date = parseDate(dateStr);
      if (!date || isNaN(date)) return escapeHtml(dateStr || '');
      const month = date.toLocaleString('default', { month: 'short' }).toUpperCase();
      const day = date.getDate();
      return `<div class="date-stack"><span class="date-month">${month}</span><span class="date-day">${day}</span></div>`;
    }

    function renderEvent(event, tbody) {
      let regionValue = event["Region"] ? event["Region"].trim().toLowerCase() : '';
      let flagHtml = '';
      // Show flag if region is a 2-letter code and not x/empty
      if (regionValue && regionValue !== 'x' && regionValue.length === 2) {
        const flagCode = getFlagCode(event["Region"], event["State"], event["City"]);
        flagHtml = `<img src="https://flagcdn.com/w80/${flagCode}.png" alt="${flagCode}">`;
      }

      let regionFullName = "";
      if (regionValue && regionValue !== 'x') {
        regionFullName = regionNameMap[regionValue] || '';
      }

      const dateCell = formatDateCell(event["Event Date"]);
      const venueLink = event["Venue Link"] || '';
      const venueName = event["Venue"] || '';
      const venueHtml =
        venueLink && venueName
          ? `<a href="${venueLink}" target="_blank">${escapeHtml(venueName)}</a>`
          : escapeHtml(venueName);
      const buyinGtd = escapeHtml(event["BuyIn / GTD"] || '');

      // Type column: emoji mapping
      const typeMap = {
        'cash': 'ðµ',
        't': 'â ',
        'www': 'ð»',
        'mu': 'ð¥³'
      };
      const typeValue = (event["Type"] || '').toLowerCase();
      const typeEmoji = typeMap[typeValue] || escapeHtml(event["Type"] || '');

      // Host clickable if hostLink present
      const host = escapeHtml(event["Host"] || '');
      const hostLink = event["Host Link"] || '';
      const hostHtml = (hostLink && host)
        ? `<a href="${hostLink}" target="_blank">${host}</a>`
        : host;

      // Series color logic
      const seriesColor = event["Series Color"] || '#000';
      const seriesName = escapeHtml(event["Series"] || '');
      const seriesDetails = event["Series Details"] || '';
      const seriesNameHtml = seriesDetails
        ? `<a href="${seriesDetails}" target="_blank" style="color:${seriesColor}; font-weight:600; text-decoration:none;">${seriesName}</a>`
        : `<span style="color:${seriesColor}; font-weight:600;">${seriesName}</span>`;

      const seriesLocation = escapeHtml(event["Series Location"] || '');
      const seriesDates = escapeHtml(event["Series Dates"] || '');

      const seriesHtml = `
        <div class="series-name">${seriesNameHtml}</div>
        <div class="series-location">${seriesLocation}</div>
        <div class="series-dates">${seriesDates}</div>
      `;

      const city = escapeHtml(event["City"] || '');
      const moreInfoText = escapeHtml(event["More Info"] || '');

      // Event fallback
      let safeEventName = event["Event"] || "(not found: " + Object.keys(event).join(", ") + ")";
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="date-cell">${dateCell}</td>
        <td class="flag-cell">${flagHtml}</td>
        <td class="series-cell">${seriesHtml}</td>
        <td class="event-cell">${escapeHtml(safeEventName)}</td>
        <td class="buyin-cell">${buyinGtd}</td>
        <td class="type-cell">${typeEmoji}</td>
        <td class="host-cell">${hostHtml}</td>
        <td class="city-cell">${city}</td>
        <td class="state-cell">${regionFullName}</td>
        <td class="venue-cell">${venueHtml}</td>
        <td class="moreinfo-cell">${moreInfoText}</td>
      `;
      tbody.appendChild(tr);
    }

    function isUpcomingEvent(event) {
      if (typeof event["Event Date"] === 'string' && event["Event Date"].toLowerCase() === 'ongoing') {
        return true;
      }
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let eventDate = parseDate(event["Event Date"]);
      if (event["Event Date"] === 'TBA' || !eventDate) {
        eventDate = parseSeriesDate(event["Series Dates"]);
      }
      if (!eventDate) return true;
      eventDate.setHours(0, 0, 0, 0);
      return eventDate >= today;
    }

    function isPastEvent(event) {
      if (typeof event["Event Date"] === 'string' && event["Event Date"].toLowerCase() === 'ongoing') {
        return false;
      }
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let eventDate = parseDate(event["Event Date"]);
      if (event["Event Date"] === 'TBA' || !eventDate) {
        eventDate = parseSeriesDate(event["Series Dates"]);
      }
      if (!eventDate) return false;
      eventDate.setHours(0, 0, 0, 0);
      return eventDate < today;
    }

    function loadCalendarData() {
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const dataArray = results.data;
          if (dataArray && dataArray.length > 0) {
            console.log("PapaParse detected fields:", Object.keys(dataArray[0]));
            console.log("First row data: ", dataArray[0]);
          }
          const upcomingTbody = document.querySelector('#calendarTable tbody');
          const pastTbody = document.querySelector('#pastCalendarTable tbody');
          upcomingTbody.innerHTML = '';
          pastTbody.innerHTML = '';
          const upcomingEvents = [];
          const pastEvents = [];
          dataArray.forEach((event) => {
            if (!event["Series"] || !event["Event Date"]) return;
            if (isUpcomingEvent(event)) {
              upcomingEvents.push(event);
            } else if (isPastEvent(event)) {
              pastEvents.push(event);
            }
          });
          sortEvents(upcomingEvents, true).forEach(event => renderEvent(event, upcomingTbody));
          sortEvents(pastEvents, false).forEach(event => renderEvent(event, pastTbody));
          $('#calendarTable').DataTable({
            responsive: true,
            scrollX: true,
            paging: true,
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50, 100],
            info: false,
            order: [],
          });
          $('#pastCalendarTable').DataTable({
            responsive: true,
            scrollX: true,
            paging: true,
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50, 100],
            info: false,
            order: [],
          });
        },
        error: function() {
          document.getElementById('calendarError').style.display = 'block';
          document.getElementById('pastCalendarError').style.display = 'block';
        }
      });
    }

    $(document).ready(() => {
      loadCalendarData();
      $('#togglePastEvents').on('click', function () {
        $('#pastEventsSection').toggleClass('collapsed');
        $(this).text(
          $('#pastEventsSection').hasClass('collapsed') ? 'Show Past Events' : 'Hide Past Events'
        );
      });
    });
  </script>
</body>
</html>
